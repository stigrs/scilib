parameters:
  jobName: ''
  imageName: ''

jobs:
- job:
  displayName: ${{ parameters.imageName }}
  pool:
    vmImage: ${{ parameters.imageName }}
  strategy:
    matrix:
      debug:
        BUILD_TYPE: 'Debug'
      release:
        BUILD_TYPE: 'Release'
  continueOnError: false

  steps:
  - script: sudo apt-get install gfortran libopenblas-dev liblapacke-dev
    name: Prepare

  - script: |
      git clone https://github.com/kokkos/stdBLAS.git
      cd stdBLAS
      mkdir build
      cd build
      cmake -DCMAKE_CXX_COMPILER=g++-11 -DCMAKE_BUILD_TYPE=$(BUILD_TYPE) ..
      sudo cmake --build . --config $(BUILD_TYPE) --target install

  - task: CMake@1
    name: Configure
    inputs:
      workingDirectory: build
      cmakeArgs: ' -DCMAKE_CXX_COMPILER=g++-11 -DCMAKE_BUILD_TYPE=$(BUILD_TYPE) -DScilib_BUILD_BENCH=OFF .. '

  - task: CMake@1
    name: Build
    inputs:
      workingDirectory: build
      cmakeArgs: '--build . --config $(BUILD_TYPE)'

  - script: ctest -C $(BUILD_TYPE) --output-on-failure --no-compress-output
    name: CTest
    workingDirectory: build
    failOnStderr: true
